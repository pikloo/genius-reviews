!function(t){"use strict";t(document).ready(function(){const e=t("#gr-upload-form"),r=t("#gr-progress"),s=t("#gr-progress-percent"),n=t("#gr-progress-bar"),a=t("#gr-stats-line"),c=t("#gr-product-rows");let d=0;function o(){t.ajax({url:GR_ADMIN.ajax,type:"POST",data:{action:"gr_process_chunk",nonce:GR_ADMIN.nonce,chunk:150},success:t=>{if(!t.success)return void a.text("Erreur: "+JSON.stringify(t.data));const e=t.data,r=Math.min(100,Math.round(e.percent));s.text(r),n.css("width",r+"%"),a.text(`Créés: ${e.created}, MAJ: ${e.updated}, Ignorés: ${e.skipped}`),c.empty(),Object.entries(e.perProduct).forEach(([t,e])=>{c.append(`\n          <tr>\n            <td class="py-1">${e.name}</td>\n            <td class="py-1">${t}</td>\n            <td class="py-1">${e.added}</td>\n            <td class="py-1">${e.updated}</td>\n            <td class="py-1">${e.skipped}</td>\n            <td class="py-1">${e.avg||"-"}</td>\n            <td class="py-1">${e.count||"-"}</td>\n          </tr>\n        `)}),e.complete?(s.text("100"),n.css("width","100%"),a.html('\n          <span class="flex items-center gap-2 text-emerald-600 font-medium">\n              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="20" height="20" fill="none">\n                  <circle cx="16" cy="16" r="16" fill="#19d873"></circle>\n                  <path d="M14 17.9L10.1 14l-2.1 2.1 6 6 10-10-2.1-2.1z" fill="#e6e6e6"/>\n              </svg>\n              Import terminé.\n          </span>\n        ')):setTimeout(o,300)},error:t=>{a.text("Erreur AJAX: "+t.responseText)}})}e.on("submit",function(e){e.preventDefault();const c=new FormData(this);r.removeClass("hidden"),n.css("width","0%"),s.text("0"),a.text("Préparation…"),t.ajax({url:GR_ADMIN.ajax,type:"POST",data:c,processData:!1,contentType:!1,success:t=>{t.success?(d=t.data.total-1,a.text(`Fichier chargé (${d} lignes).`),o()):alert("Erreur: "+JSON.stringify(t.data))},error:t=>{alert("Erreur upload: "+t.responseText)}})})})}(jQuery);